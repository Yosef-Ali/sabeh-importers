// Sabeh Importers Database Schema
// PostgreSQL with Neon

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER & AUTH ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  nameAmharic   String?   @map("name_amharic")
  phone         String?
  password      String
  role          UserRole  @default(STAFF)
  avatar        String?
  isActive      Boolean   @default(true) @map("is_active")
  lastLogin     DateTime? @map("last_login")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  orders        Order[]
  activities    ActivityLog[]
  notifications Notification[]
  
  // Marketplace
  listings            Listing[]
  buyerConversations  Conversation[] @relation("BuyerConversations")
  sellerConversations Conversation[] @relation("SellerConversations")
  sentMessages        Message[]

  @@map("users")
}

enum UserRole {
  ADMIN
  MANAGER
  STAFF
  DISTRIBUTOR
}

// ==================== PRODUCTS & INVENTORY ====================

model Category {
  id          String    @id @default(cuid())
  name        String
  nameAmharic String?   @map("name_amharic")
  slug        String    @unique
  description String?
  image       String?
  parentId    String?   @map("parent_id")
  parent      Category? @relation("CategoryToCategory", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryToCategory")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  products    Product[]

  @@map("categories")
}

model Product {
  id              String   @id @default(cuid())
  sku             String   @unique
  name            String
  nameAmharic     String?  @map("name_amharic")
  description     String?
  descriptionAmharic String? @map("description_amharic")
  categoryId      String   @map("category_id")
  category        Category @relation(fields: [categoryId], references: [id])
  brand           String?
  unit            String   @default("piece") // piece, kg, box, carton
  unitAmharic     String?  @map("unit_amharic")
  
  // Pricing
  costPrice       Decimal  @map("cost_price") @db.Decimal(12, 2)
  wholesalePrice  Decimal  @map("wholesale_price") @db.Decimal(12, 2)
  retailPrice     Decimal  @map("retail_price") @db.Decimal(12, 2)
  currency        Currency @default(ETB)
  
  // Stock
  minStockLevel   Int      @default(10) @map("min_stock_level")
  maxStockLevel   Int?     @map("max_stock_level")
  
  // Media
  images          String[] @default([])
  thumbnail       String?
  
  // Status
  isActive        Boolean  @default(true) @map("is_active")
  isFeatured      Boolean  @default(false) @map("is_featured")
  
  // SEO & Catalog
  tags            String[] @default([])
  barcode         String?
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  inventory       Inventory[]
  orderItems      OrderItem[]
  catalogItems    CatalogItem[]

  @@map("products")
}

enum Currency {
  ETB
  USD
}

model Inventory {
  id          String    @id @default(cuid())
  productId   String    @map("product_id")
  product     Product   @relation(fields: [productId], references: [id])
  warehouseId String    @map("warehouse_id")
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  quantity    Int       @default(0)
  reserved    Int       @default(0) // Reserved for pending orders
  available   Int       @default(0) // quantity - reserved
  lastRestock DateTime? @map("last_restock")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  movements   StockMovement[]

  @@unique([productId, warehouseId])
  @@map("inventory")
}

model Warehouse {
  id          String    @id @default(cuid())
  name        String
  nameAmharic String?   @map("name_amharic")
  code        String    @unique
  address     String?
  city        String
  region      String?
  phone       String?
  managerId   String?   @map("manager_id")
  isActive    Boolean   @default(true) @map("is_active")
  isDefault   Boolean   @default(false) @map("is_default")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  inventory   Inventory[]
  movements   StockMovement[]

  @@map("warehouses")
}

model StockMovement {
  id          String        @id @default(cuid())
  inventoryId String        @map("inventory_id")
  inventory   Inventory     @relation(fields: [inventoryId], references: [id])
  warehouseId String        @map("warehouse_id")
  warehouse   Warehouse     @relation(fields: [warehouseId], references: [id])
  type        MovementType
  quantity    Int
  reference   String?       // Order ID or adjustment reason
  notes       String?
  createdBy   String        @map("created_by")
  createdAt   DateTime      @default(now()) @map("created_at")

  @@map("stock_movements")
}

enum MovementType {
  IN          // Stock received
  OUT         // Stock sold/shipped
  ADJUSTMENT  // Manual adjustment
  TRANSFER    // Transfer between warehouses
  RETURN      // Customer return
  DAMAGED     // Damaged goods
}

// ==================== CUSTOMERS & DISTRIBUTORS ====================

model Customer {
  id              String       @id @default(cuid())
  type            CustomerType @default(RETAIL)
  name            String
  nameAmharic     String?      @map("name_amharic")
  email           String?
  phone           String
  whatsapp        String?
  address         String?
  city            String?
  region          String?
  tinNumber       String?      @map("tin_number") // Tax ID
  creditLimit     Decimal?     @map("credit_limit") @db.Decimal(12, 2)
  balance         Decimal      @default(0) @db.Decimal(12, 2)
  notes           String?
  isActive        Boolean      @default(true) @map("is_active")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  orders          Order[]
  payments        Payment[]
  whatsappChats   WhatsAppChat[]

  @@map("customers")
}

enum CustomerType {
  RETAIL
  WHOLESALE
  DISTRIBUTOR
}

model Distributor {
  id              String            @id @default(cuid())
  code            String            @unique
  name            String
  nameAmharic     String?           @map("name_amharic")
  contactPerson   String            @map("contact_person")
  email           String?
  phone           String
  whatsapp        String?
  address         String
  city            String
  region          String
  territory       String[]          @default([]) // Assigned regions/zones
  
  // Business Info
  tinNumber       String?           @map("tin_number")
  businessLicense String?           @map("business_license")
  
  // Terms
  creditLimit     Decimal           @map("credit_limit") @db.Decimal(12, 2)
  paymentTerms    Int               @default(30) @map("payment_terms") // Days
  discountRate    Decimal           @default(0) @map("discount_rate") @db.Decimal(5, 2)
  
  // Performance
  totalOrders     Int               @default(0) @map("total_orders")
  totalRevenue    Decimal           @default(0) @map("total_revenue") @db.Decimal(14, 2)
  balance         Decimal           @default(0) @db.Decimal(12, 2)
  rating          Decimal?          @db.Decimal(3, 2)
  
  // Status
  status          DistributorStatus @default(PENDING)
  onboardedAt     DateTime?         @map("onboarded_at")
  isActive        Boolean           @default(true) @map("is_active")
  
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  orders          Order[]
  payments        Payment[]

  @@map("distributors")
}

enum DistributorStatus {
  PENDING
  APPROVED
  SUSPENDED
  TERMINATED
}

// ==================== ORDERS & PAYMENTS ====================

model Order {
  id              String      @id @default(cuid())
  orderNumber     String      @unique @map("order_number")
  
  // Customer/Distributor
  customerId      String?     @map("customer_id")
  customer        Customer?   @relation(fields: [customerId], references: [id])
  distributorId   String?     @map("distributor_id")
  distributor     Distributor? @relation(fields: [distributorId], references: [id])
  
  // Order Details
  status          OrderStatus @default(PENDING)
  type            OrderType   @default(SALES)
  source          OrderSource @default(DIRECT)
  
  // Amounts
  subtotal        Decimal     @db.Decimal(12, 2)
  discount        Decimal     @default(0) @db.Decimal(12, 2)
  tax             Decimal     @default(0) @db.Decimal(12, 2)
  shipping        Decimal     @default(0) @db.Decimal(12, 2)
  total           Decimal     @db.Decimal(12, 2)
  currency        Currency    @default(ETB)
  
  // Payment
  paymentStatus   PaymentStatus @default(UNPAID) @map("payment_status")
  paidAmount      Decimal     @default(0) @map("paid_amount") @db.Decimal(12, 2)
  dueDate         DateTime?   @map("due_date")
  
  // Shipping
  shippingAddress String?     @map("shipping_address")
  shippingCity    String?     @map("shipping_city")
  shippingRegion  String?     @map("shipping_region")
  shippingPhone   String?     @map("shipping_phone")
  trackingNumber  String?     @map("tracking_number")
  
  // Additional Info
  notes           String?
  internalNotes   String?     @map("internal_notes")
  
  // User
  createdById     String      @map("created_by_id")
  createdBy       User        @relation(fields: [createdById], references: [id])
  
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  items           OrderItem[]
  payments        Payment[]
  statusHistory   OrderStatusHistory[]

  @@map("orders")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
}

enum OrderType {
  SALES
  PURCHASE
  RETURN
}

enum OrderSource {
  DIRECT
  WHATSAPP
  PHONE
  ONLINE
  DISTRIBUTOR
}

enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
  REFUNDED
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String   @map("order_id")
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String   @map("product_id")
  product     Product  @relation(fields: [productId], references: [id])
  quantity    Int
  unitPrice   Decimal  @map("unit_price") @db.Decimal(12, 2)
  discount    Decimal  @default(0) @db.Decimal(12, 2)
  total       Decimal  @db.Decimal(12, 2)
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("order_items")
}

model OrderStatusHistory {
  id        String      @id @default(cuid())
  orderId   String      @map("order_id")
  order     Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  status    OrderStatus
  notes     String?
  createdBy String      @map("created_by")
  createdAt DateTime    @default(now()) @map("created_at")

  @@map("order_status_history")
}

model Payment {
  id            String        @id @default(cuid())
  orderId       String?       @map("order_id")
  order         Order?        @relation(fields: [orderId], references: [id])
  customerId    String?       @map("customer_id")
  customer      Customer?     @relation(fields: [customerId], references: [id])
  distributorId String?       @map("distributor_id")
  distributor   Distributor?  @relation(fields: [distributorId], references: [id])
  
  amount        Decimal       @db.Decimal(12, 2)
  currency      Currency      @default(ETB)
  method        PaymentMethod
  reference     String?       // Transaction ID, check number, etc.
  status        PaymentTransactionStatus @default(PENDING)
  notes         String?
  
  paidAt        DateTime?     @map("paid_at")
  createdBy     String        @map("created_by")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  @@map("payments")
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  TELEBIRR
  CBE_BIRR
  MPESA
  CHECK
  CREDIT
}

enum PaymentTransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// ==================== CATALOG (Digital Product Catalog) ====================

model Catalog {
  id          String   @id @default(cuid())
  name        String
  nameAmharic String?  @map("name_amharic")
  description String?
  slug        String   @unique
  coverImage  String?  @map("cover_image")
  isPublished Boolean  @default(false) @map("is_published")
  validFrom   DateTime? @map("valid_from")
  validUntil  DateTime? @map("valid_until")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  items       CatalogItem[]

  @@map("catalogs")
}

model CatalogItem {
  id          String   @id @default(cuid())
  catalogId   String   @map("catalog_id")
  catalog     Catalog  @relation(fields: [catalogId], references: [id], onDelete: Cascade)
  productId   String   @map("product_id")
  product     Product  @relation(fields: [productId], references: [id])
  sortOrder   Int      @default(0) @map("sort_order")
  specialPrice Decimal? @map("special_price") @db.Decimal(12, 2)
  isHighlighted Boolean @default(false) @map("is_highlighted")
  createdAt   DateTime @default(now()) @map("created_at")

  @@unique([catalogId, productId])
  @@map("catalog_items")
}

// ==================== WHATSAPP INTEGRATION ====================

model WhatsAppChat {
  id          String   @id @default(cuid())
  customerId  String?  @map("customer_id")
  customer    Customer? @relation(fields: [customerId], references: [id])
  phone       String
  name        String?
  status      ChatStatus @default(ACTIVE)
  lastMessage DateTime? @map("last_message")
  unreadCount Int       @default(0) @map("unread_count")
  assignedTo  String?   @map("assigned_to")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  messages    WhatsAppMessage[]

  @@map("whatsapp_chats")
}

enum ChatStatus {
  ACTIVE
  PENDING
  RESOLVED
  SPAM
}

model WhatsAppMessage {
  id          String          @id @default(cuid())
  chatId      String          @map("chat_id")
  chat        WhatsAppChat    @relation(fields: [chatId], references: [id], onDelete: Cascade)
  direction   MessageDirection
  type        MessageType     @default(TEXT)
  content     String
  mediaUrl    String?         @map("media_url")
  status      MessageStatus   @default(SENT)
  sentAt      DateTime        @default(now()) @map("sent_at")
  deliveredAt DateTime?       @map("delivered_at")
  readAt      DateTime?       @map("read_at")

  @@map("whatsapp_messages")
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageType {
  TEXT
  IMAGE
  DOCUMENT
  CATALOG
  ORDER
  LOCATION
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

// ==================== SYSTEM ====================

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id])
  action      String
  entity      String   // e.g., "order", "product", "customer"
  entityId    String?  @map("entity_id")
  details     Json?
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("activity_logs")
}

model Notification {
  id          String           @id @default(cuid())
  userId      String           @map("user_id")
  user        User             @relation(fields: [userId], references: [id])
  type        NotificationType
  title       String
  message     String
  link        String?
  isRead      Boolean          @default(false) @map("is_read")
  readAt      DateTime?        @map("read_at")
  createdAt   DateTime         @default(now()) @map("created_at")

  @@map("notifications")
}

enum NotificationType {
  ORDER
  PAYMENT
  STOCK
  SYSTEM
  WHATSAPP
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  group     String   @default("general")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

// ==================== MARKETPLACE (Sabeh Market) ====================

model Listing {
  id          String    @id @default(cuid())
  sellerId    String    @map("seller_id")
  seller      User      @relation(fields: [sellerId], references: [id])
  
  title       String
  description String
  price       Decimal   @db.Decimal(12, 2)
  currency    Currency  @default(ETB)
  
  categoryId  String    @map("category_id")
  category    ListingCategory @relation(fields: [categoryId], references: [id])
  
  images      String[]  @default([])
  location    String?   // Text representation
  latitude    Float?
  longitude   Float?
  
  status      ListingStatus @default(ACTIVE)
  
  isPromoted  Boolean   @default(false) @map("is_promoted")
  
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  conversations Conversation[]

  @@map("listings")
}

enum ListingStatus {
  DRAFT
  ACTIVE
  SOLD
  EXPIRED
  DELETED
}

model ListingCategory {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  icon        String?
  parentId    String?   @map("parent_id")
  parent      ListingCategory? @relation("SubCategories", fields: [parentId], references: [id])
  children    ListingCategory[] @relation("SubCategories")
  
  listings    Listing[]

  @@map("listing_categories")
}

model Conversation {
  id          String    @id @default(cuid())
  listingId   String    @map("listing_id")
  listing     Listing   @relation(fields: [listingId], references: [id])
  
  buyerId     String    @map("buyer_id")
  buyer       User      @relation("BuyerConversations", fields: [buyerId], references: [id])
  
  sellerId    String    @map("seller_id")
  seller      User      @relation("SellerConversations", fields: [sellerId], references: [id])
  
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  messages    Message[]

  @@unique([listingId, buyerId])
  @@map("conversations")
}

model Message {
  id              String    @id @default(cuid())
  conversationId  String    @map("conversation_id")
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  senderId        String    @map("sender_id")
  sender          User      @relation(fields: [senderId], references: [id])
  
  content         String
  isRead          Boolean   @default(false) @map("is_read")
  readAt          DateTime? @map("read_at")
  
  createdAt       DateTime  @default(now()) @map("created_at")

  @@map("messages")
}
